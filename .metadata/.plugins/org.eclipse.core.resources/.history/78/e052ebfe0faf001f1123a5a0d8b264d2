<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ page import="java.sql.*, java.time.*, java.time.format.DateTimeFormatter, java.time.temporal.ChronoUnit, termpackage.DBConnection" %>
<%@ page session="true" %>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒí’ˆ ìƒì„¸ì •ë³´</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="../css/item_info.css"> 
</head>
<body style="overflow-x: hidden">
	<header class="header">
        <img src="../images/top_banner.svg" alt="ë§¨ìœ„ ë¡œê³ " class="top-bar">
        <div class="search-bar">
            <a href="../index.jsp"><img src="../images/main_logo.svg" alt="ë¡œê³ " class="logo"></a>
            <form id="searchForm" action="search_result.html" method="GET">
                <div class="search-input-container">
                    <input type="text" placeholder="ğŸ” ë¬¼í’ˆëª…, ì¥í„°ëª…, ì¹´í…Œê³ ë¦¬ íƒœê·¸ ë“±" class="search-input" id="searchInput" name="query">
                    <button type="submit" class="search-button" id="searchButton">ğŸ”</button>
                </div>
            </form>
            <div class="icons">
                <a href="bookmark.jsp"><span><img src="../images/bookmark01.png" alt="ë¶ë§ˆí¬" class="icons"></span></a>
                <span><img src="../images/favorite01.png" alt="ì¦ê²¨ì°¾ê¸°" class="icons"></span>
                <a href="my_interface.jsp"><span><img src="../images/interpace01.png" alt="ë‚´ì •ë³´" class="icons"></span></a>

                <% 
                // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ í›„ ì•„ì´ë””ì™€ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í‘œì‹œ
                String username = (String) session.getAttribute("username");
                if (username != null) { 
                %>
                    <span class="username-display"><%= username %></span>
                    <a href="../html/logout.jsp">
                        <input type="button" class="logout-button" value="ë¡œê·¸ì•„ì›ƒ">
                    </a>
                <% 
                } else { 
                %>
                    <a href="../html/login.html">
                        <input type="button" class="login-button" value="ë¡œê·¸ì¸">
                    </a>
                <% 
                } 
                %>
             </div>
        </div>
        <nav class="menu-bar">
            <ul>
                <li><a href="#"><img src="../images/category.svg" alt="ì¹´í…Œê³ ë¦¬">ì¹´í…Œê³ ë¦¬</a></li>
                <li><a href="../index.html#my-wants">ë‚´ê°€ ì›í•´ìš”</a></li>
                <li><a href="../index.html#others-wants">ìƒëŒ€ë°©ì´ ì›í•´ìš”</a></li>     
                <li><a href="#">ê¸‰ìƒìŠ¹</a></li>
                <li><a href="#">ì™</a></li>
                <li><a href="#">ì´ë²¤íŠ¸</a></li>
                <li><a href="item.jsp">ìƒí’ˆë“±ë¡</a></li>
                
            </ul>
        </nav>    
    </header>
    	<div class="main-content">
        <div class="item-info">
            <%
                String productId = request.getParameter("product_id");
                if (productId != null) {
                    Connection conn = null;
                    PreparedStatement pstmt = null;
                    ResultSet rs = null;

                    try {
                        conn = DBConnection.getConnection();
                        String query = "SELECT pd_name, pd_price, pd_image, pd_information, category, trade_method, owner, created_at " +
                                       "FROM products WHERE product_id = ?";
                        pstmt = conn.prepareStatement(query);
                        pstmt.setInt(1, Integer.parseInt(productId));
                        rs = pstmt.executeQuery();

                        if (rs.next()) {
                            String pdName = rs.getString("pd_name");
                            int pdPrice = rs.getInt("pd_price");
                            String pdImage = rs.getString("pd_image");
                            String pdInformation = rs.getString("pd_information");
                            String category = rs.getString("category");
                            String tradeMethod = rs.getString("trade_method");
                            String owner = rs.getString("owner");
                            Timestamp createdAtTimestamp = rs.getTimestamp("created_at");

                            // í˜„ì¬ ì‹œê°„ê³¼ ìƒí’ˆ ë“±ë¡ ì‹œê°„ ë¹„êµ
							LocalDateTime createdAt = createdAtTimestamp.toLocalDateTime();
							LocalDateTime now = LocalDateTime.now();
							long secondsBetween = ChronoUnit.SECONDS.between(createdAt, now);
							long minutesBetween = ChronoUnit.MINUTES.between(createdAt, now);
							long hoursBetween = ChronoUnit.HOURS.between(createdAt, now);
							long daysBetween = ChronoUnit.DAYS.between(createdAt, now);
							long monthsBetween = ChronoUnit.MONTHS.between(createdAt, now);
							long yearsBetween = ChronoUnit.YEARS.between(createdAt, now);
							
							String timeAgo;
							
							if (secondsBetween < 60) {
							    timeAgo = secondsBetween + "ì´ˆ ì „";
							} else if (minutesBetween < 60) {
							    timeAgo = minutesBetween + "ë¶„ ì „";
							} else if (hoursBetween < 24) {
							    timeAgo = hoursBetween + "ì‹œê°„ ì „";
							} else if (daysBetween < 30) {
							    timeAgo = daysBetween + "ì¼ ì „";
							} else if (monthsBetween < 12) {
							    timeAgo = monthsBetween + "ê°œì›” ì „";
							} else {
							    timeAgo = yearsBetween + "ë…„ ì „";
							}

            %>
                            <!-- ìƒí’ˆ ìƒì„¸ ì •ë³´ -->

			        <div class="product-header">
			            <!-- ì™¼ìª½ ì´ë¯¸ì§€ ì˜ì—­ -->
					    <div class="photo-container">
					        <img src="<%= "../" + pdImage %>" alt="ìƒí’ˆ ì´ë¯¸ì§€" class="product-image">
					    </div>
			            <!-- ì„¸ë¡œ êµ¬ë¶„ì„  -->
			            <div style="width: 1px; height: 400px; background-color: #ddd; margin: 20px 0;
			            	 margin-right: 5px; margin-left: 15px;"></div>
			            <!-- ì˜¤ë¥¸ìª½ ìƒí’ˆ ì •ë³´ ì˜ì—­ -->
			            <div class="product-maininfo">
			                <div class="info-top">
			                    <a href="category_result.jsp?category=<%= java.net.URLEncoder.encode(category, "UTF-8") %>" class="category-link"><%= category %></a>>
			                    <a href="#" class="brand-link">ì‚¼ì„±</a> 
			                    <div class="item-name"><%=pdName %></div>
			                </div>
						<div class="info-middle">
						    <div class="trade-info">
						        <div class="trade-method-info" style="display: flex; flex-wrap: wrap;">
						            <% 
						            boolean hasSell = tradeMethod != null && tradeMethod.contains("sell");
						            boolean hasExchange = tradeMethod != null && tradeMethod.contains("exchange");
						
						            // ê±°ë˜ ë°©ì‹ì— ë§ëŠ” ì•„ì´ì½˜ ì¶”ê°€
						            if (hasSell) { 
						            %>
						                <div class="trade-icon">
						                    <img src="../images/sell-icon.svg" alt="íŒë§¤ ì•„ì´ì½˜">
						                </div>
						            <% } 
						
						            if (hasExchange) { 
						            %>
						                <div class="trade-icon">
						                    <img src="../images/trade-icon.svg" alt="êµí™˜ ì•„ì´ì½˜">
						                </div>
						            <% } 
						            %>
						        </div>
						        <div class="trade-details">
						            <a href="category_result.jsp?category=<%= java.net.URLEncoder.encode(category, "UTF-8") %>" class="category-link"><%= category %></a>
						            <div class="trade-price"><%= pdPrice %> ì›</div>
						        </div>
						    </div>
						</div>




			                <div class="info-bottom">
			                    <div class="heart-count-icon"><img src="../images/fill-heart.svg"></div>
			                    <div class="heart-count">2</div>
			                    <div class="divider"></div>
			                    <div class="view-count-icon"><img src="../images/fill-eye.svg"></div>
			                    <div class="view-count">87</div>
			                    <div class="divider"></div>
			                    <div class="time-count-icon"><img src="../images/fill-clock.svg"></div>
			                    <div class="time-count"><%=timeAgo %></div>
			                    <a href="#" class="report-link">
			                        <div class="report-icon"><img src="../images/fill-report.svg"></div>
			                        <div class="report">ì‹ ê³ í•˜ê¸°</div>
			                    </a>
			                </div>
			                <div class="buttons">
			                    <a href="#" class="heart-button-link"><img src="../images/heart.svg" alt="ì™" class="heart-button"></a>
			                    <a href="#" class="chat-button">ëŒ€í™”í•˜ê¸°</a>
			                    <a href="trade-offer.jsp" class="trade-button">ê±°ë˜í•˜ê¸°</a>
			                </div>
			            </div>
			        </div>
			        <div class="product-subinfo">
			            <div class="infotext">
			                <div class="infotext-title"><h2>ìƒí’ˆì •ë³´</h2></div>
			                <div class="infotext-text"><%=pdInformation %></div>
			            </div>
			            <div class="shopinfo">
			                <div class="shopinfo-title"><h2>ì°½ê³ ì •ë³´</h2></div>
			                <div class="shopinfo-top">
			                    <div class="shop-img"><img src="../images/account.svg"></div>
			                    <div class="shop-details">
			                        <div class="shop-name"><%=owner %>ë‹˜ì˜ ì°½ê³ </div>   <!-- ë‚˜ì¤‘ì— nicknameìœ¼ë¡œ ë°”ê¿”ì•¼í• ê±°ê°™ìŒ -->
			                        <div class="shop-sum">
			                            <a href="#">ë¬¼í’ˆ<div class="user-item-count">2</div></a>
			                            <div class="divider-small"></div>
			                            <a href="#">íŒ”ë¡œì›Œ<div class="user-follower-count">10</div></a>
			                            <div class="divider-small"></div>
			                            <a href="#">ê±°ë˜í›„ê¸°<div class="user-review-count">4</div></a>
			                        </div>
			                    </div>
			                </div>
			                <div class="clover">
			                    <div class="clover-title">í´ë¡œë²„ì§€ìˆ˜</div>
			                    <div class="clover-point">53 / 100</div>
			                </div>
			                <div class="clover-bar">
			                    <div class="progress2 progress-moved">
			                        <div class="progress-bar2"></div>
			                    </div>
			                </div>
			            </div>
			        </div>
					<div class="simmilar">
					    <div class="silmmiliar-title"><h2>ë¹„ìŠ·í•œ ë¬¼í’ˆ ì¶”ì²œ</h2></div>
					    <div class="lastest-item">
					        <%
					            if (productId != null && category != null) {
					                PreparedStatement similarPstmt = null;
					                ResultSet similarRs = null;
					                try {
					                    String similarQuery = "SELECT pd_name, pd_price, pd_image, product_id, trade_method FROM products " +
					                                          "WHERE category = ? AND product_id != ? ORDER BY RAND() LIMIT 8";
					                    similarPstmt = conn.prepareStatement(similarQuery);
					                    similarPstmt.setString(1, category);
					                    similarPstmt.setInt(2, Integer.parseInt(productId));
					                    similarRs = similarPstmt.executeQuery();
					
					                    while (similarRs.next()) {
					                        String similarName = similarRs.getString("pd_name");
					                        int similarPrice = similarRs.getInt("pd_price");
					                        String similarImage = similarRs.getString("pd_image");
					                        int similarId = similarRs.getInt("product_id");
					        %>
					                        <div class="product-container">
					                        	<div class="want-item">
						                            <a href="item_info.jsp?product_id=<%= similarId %>">
						                                <img src="<%= "../" + similarImage %>" alt="<%= similarName %>" class="pd-image">
						                                <div class="item-details">
						                                    <div class="pd-name"><%= similarName %></div>
						                                    <div class="pd-price"><%= similarPrice %> ì›</div>
						                                </div>
						                            </a>
						                        </div>
					                        </div>
					        <%
					                    }
					                } catch (Exception e) {
					                    out.println("<p>ë¹„ìŠ·í•œ ë¬¼í’ˆì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.getMessage() + "</p>");
					                } finally {
					                    try { if (similarRs != null) similarRs.close(); } catch (SQLException ignored) {}
					                    try { if (similarPstmt != null) similarPstmt.close(); } catch (SQLException ignored) {}
					                }
					            }
					        %>
					    </div>
					</div>



            <%
                        } else {
                            out.println("<p>ìƒí’ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>");
                        }
                    } catch (Exception e) {
                        out.println("<p>ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜: " + e.getMessage() + "</p>");
                    } finally {
                        try { if (rs != null) rs.close(); } catch (SQLException ignored) {}
                        try { if (pstmt != null) pstmt.close(); } catch (SQLException ignored) {}
                        try { if (conn != null) conn.close(); } catch (SQLException ignored) {}
                    }
                } else {
                    out.println("<p>ìƒí’ˆ IDê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>");
                }
            %>
        </div>
    </div>
    
    
    <script src="../scripts.js"></script>
</body>
</html>

ì´ê²Œ ì „ì²´ì½”ë“œì„

   	 while (rs.next()) {
			                     String tradeMethod = rs.getString("trade_method"); // trade_method ê°’ì„ ê°€ì ¸ì˜´
			                     String tradeIcons = "";

			                     // trade_methodê°€ ','ë¡œ êµ¬ë¶„ëœ ê°’ì„ í¬í•¨í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì´ë¥¼ ì²˜ë¦¬
			                     if (tradeMethod != null) {
			                         String[] methods = tradeMethod.split(","); // ì½¤ë§ˆë¡œ êµ¬ë¶„ëœ ê°’ì„ ë°°ì—´ë¡œ ë¶„ë¦¬

			                         // 'exchange'ì™€ 'sell' ê°’ì„ í™•ì¸í•´ì„œ ê°ê° ì•„ì´ì½˜ì„ ì§€ì •
			                         for (String method : methods) {
			                             if ("exchange".equalsIgnoreCase(method.trim())) {
			                                 tradeIcons += "<img src='images/trade-icon.svg' alt='ë¬¼ë¬¼êµí™˜ ì•„ì´ì½˜' class='trade-icon'>"; // êµí™˜ ì•„ì´ì½˜
			                             } else if ("sell".equalsIgnoreCase(method.trim())) {
			                                 tradeIcons += "<img src='images/sell-icon.svg' alt='íŒë§¤ ì•„ì´ì½˜' class='trade-icon'>"; // íŒë§¤ ì•„ì´ì½˜
			                             }
			                         }
			                     }