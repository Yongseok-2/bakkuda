<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ page import="java.sql.*, termpackage.DBConnection" %>
<%@ page session="true" %>

<%
    String username = (String) session.getAttribute("username");

    if (username == null) {
        out.println("<script>alert('ë¡œê·¸ì¸ì„ í•˜ì…”ì•¼ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); location.href='../html/login.html';</script>");
        return;
    }

    try (Connection conn = DBConnection.getConnection();
         PreparedStatement pstmt = conn.prepareStatement("SELECT market_name, description, market_image FROM market WHERE owner = ?")) {
        pstmt.setString(1, username);
        ResultSet rs = pstmt.executeQuery();

        if (rs.next()) {
            String marketName = rs.getString("market_name");
            String description = rs.getString("description");
            String marketImage = rs.getString("market_image");
%>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´í˜ì´ì§€</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="../css/main2.css">
    <link rel="stylesheet" href="../css/interface.css">
</head>
<body style="overflow-x: hidden">
    <header class="header">
        <img src="../images/top_banner.svg" alt="ë§¨ìœ„ ë¡œê³ " class="top-bar">
        <div class="search-bar">
            <a href="../index.jsp"><img src="../images/main_logo.svg" alt="ë¡œê³ " class="logo"></a>
            <form id="searchForm" action="search_result.jsp" method="GET">
                <div class="search-input-container">
                    <input type="text" placeholder="ğŸ” ë¬¼í’ˆëª…, ì¥í„°ëª…, ì¹´í…Œê³ ë¦¬ íƒœê·¸ ë“±" class="search-input" id="searchInput" name="query">
                    <button type="submit" class="search-button" id="searchButton">ğŸ”</button>
                </div>
            </form>
            <div class="icons">
                <a href="bookmark.jsp"><span><img src="../images/bookmark01.png" alt="ë¶ë§ˆí¬" class="icons"></span></a>
                <span><img src="../images/favorite01.png" alt="ì¦ê²¨ì°¾ê¸°" class="icons"></span>
                <a href="my_interface.jsp"><span><img src="../images/interpace01.png" alt="ë‚´ì •ë³´" class="icons"></span></a>
                <span class="username-display"><%= username %></span>
                <a href="../html/logout.jsp"><input type="button" class="logout-button" value="ë¡œê·¸ì•„ì›ƒ"></a>
            </div>
        </div>
        <nav class="menu-bar">
            <ul>
                <li><a href="#">ì¹´í…Œê³ ë¦¬</a></li>
                <li><a href="../index.html#my-wants">ë‚´ê°€ ì›í•´ìš”</a></li>
                <li><a href="../index.html#others-wants">ìƒëŒ€ë°©ì´ ì›í•´ìš”</a></li>
                <li><a href="#">ê¸‰ìƒìŠ¹</a></li>
                <li><a href="#">ì™</a></li>
                <li><a href="#">ì´ë²¤íŠ¸</a></li>
                <li><a href="item.jsp">ìƒí’ˆë“±ë¡</a></li>
            </ul>
        </nav>
    </header>

    <main class="interface-main">
        <div class="interface-container">
            <div class="photo-container">
                <div class="empty-image">
                    <img src="<%= "../" + marketImage %>" alt="ì¥í„° ì´ë¯¸ì§€" class="market-image">
                </div>
                <div class="buttons">
                    <button id="editBtn" class="chat-button" onclick="toggleEditMode()">ìˆ˜ì •í•˜ê¸°</button>
                </div>
            </div>

            <!-- ìˆ˜ì • í¼ (ìˆ¨ê²¨ì§„ ìƒíƒœë¡œ ì‹œì‘) -->
            <div id="editForm" style="display:none;">
                <form action="update_market.jsp" method="POST" enctype="multipart/form-data">
                    <label for="newImage">ìƒˆ ì´ë¯¸ì§€:</label>
                    <input type="file" id="newImage" name="newImage"><br><br>

                    <label for="newMarketName">ì¥í„° ì´ë¦„:</label>
                    <input type="text" id="newMarketName" name="newMarketName" value="<%= marketName %>"><br><br>

                    <label for="newDescription">ì¥í„° ì„¤ëª…:</label>
                    <textarea id="newDescription" name="newDescription"><%= description %></textarea><br><br>

                    <button type="submit">ìˆ˜ì • ì™„ë£Œ</button>
                </form>
            </div>

            <!-- ì¶”ê°€ì ì¸ ì‚¬ìš©ì ì •ë³´ì™€ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ë“±... -->
        </div>
    </main>

    <script src="../scripts.js"></script>
    <script src="../js/interface.js"></script>

    <script>
        function toggleEditMode() {
            var editForm = document.getElementById('editForm');
            var editBtn = document.getElementById('editBtn');

            if (editForm.style.display === "none") {
                editForm.style.display = "block";
                editBtn.textContent = "ì·¨ì†Œí•˜ê¸°";
            } else {
                editForm.style.display = "none";
                editBtn.textContent = "ìˆ˜ì •í•˜ê¸°";
            }
        }
    </script>

</body>
</html>

<%
        } else {
            out.println("<script>alert('ì¥í„° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); history.back();</script>");
        }
    } catch (SQLException e) {
        e.printStackTrace();
        out.println("<script>alert('ì˜¤ë¥˜ ë°œìƒ: " + e.getMessage() + "'); history.back();</script>");
    }
%>
